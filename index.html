<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Northern Shan Maps ‚Äî Auto Index</title>
  <style>
    :root { --bg:#0b0d12; --card:#141925; --text:#e9eef7; --muted:#9fb0c7; --accent:#69a7ff; --border:#263148; }
    html,body{height:100%; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;}
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }
    header { max-width:1100px; margin:32px auto 8px; padding:0 16px; }
    header h1 { margin:0 0 6px; font-weight:700; letter-spacing:.3px; }
    header p { margin:0; color:var(--muted); }
    #controls{max-width:1100px; margin:12px auto 0; padding:0 16px; display:flex; gap:12px; flex-wrap:wrap;}
    input[type="search"]{flex:1 1 280px; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:var(--card); color:var(--text);}
    select{padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:var(--card); color:var(--text);}
    main { max-width:1100px; margin:16px auto 40px; padding:0 16px; }
    .grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:16px; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:14px; overflow:hidden; display:flex; flex-direction:column; }
    .thumb { aspect-ratio: 16 / 10; background:#0f141f; display:flex; align-items:center; justify-content:center; overflow:hidden; }
    .thumb img{width:100%; height:100%; object-fit:cover; display:block;}
    .thumb .fallback { color:var(--muted); font-size:14px; padding:10px; text-align:center; }
    .meta { padding:12px 14px; display:flex; gap:8px; flex-direction:column; }
    .name { font-weight:600; line-height:1.3; }
    .row { display:flex; align-items:center; gap:10px; justify-content:space-between; color:var(--muted); font-size:12px; }
    .badges { display:flex; gap:6px; flex-wrap:wrap; }
    .badge { font-size:11px; padding:2px 8px; border-radius:999px; border:1px solid var(--border); background:#0f1623; color:var(--muted); }
    .links { display:flex; gap:10px; margin-top:4px; }
    .btn { display:inline-block; font-size:13px; padding:7px 10px; border-radius:10px; border:1px solid var(--border); background:#0f1623; color:var(--text); }
    .btn:hover { background:#0e1a2b; text-decoration:none; }
    footer { max-width:1100px; margin:8px auto 40px; padding:0 16px; color:var(--muted); font-size:12px; }
    .hidden{display:none !important;}
  </style>
</head>
<body>
  <header>
    <h1>üìç Northern Shan Maps (Auto‚ÄëIndex)</h1>
    <p>All <code>.html</code> map files in this repository. Thumbnails are shown if a same‚Äëname <code>.png/.jpg/.webp</code> exists.</p>
  </header>

  <section id="controls">
    <input id="search" type="search" placeholder="Search maps by name‚Ä¶" />
    <select id="folderFilter">
      <option value="">All folders</option>
    </select>
  </section>

  <main>
    <div id="grid" class="grid" role="list"></div>
  </main>

  <footer>
    <div id="status">Loading‚Ä¶</div>
  </footer>

<script>
(async function () {
  // --- CONFIG / AUTO-DETECT ---
  // If hosted on GitHub Pages under https://USER.github.io/REPO/, derive owner/repo from path.
  // Otherwise, you can hardcode OWNER/REPO below.
  const pathParts = location.pathname.replace(/^\/+/,'').split('/');
  let OWNER = pathParts[0]?.endsWith('.github.io') ? pathParts[0].replace('.github.io','') : pathParts[0];
  let REPO  = pathParts[0]?.endsWith('.github.io') ? pathParts[1] : pathParts[1] || 'northernshan-map';

  // Fallbacks if opened locally
  if (!OWNER || !REPO) { OWNER = 'TamNguyen3819'; REPO = 'northernshan-map'; }

  const repoApi      = `https://api.github.com/repos/${OWNER}/${REPO}`;
  const contentsApi  = (path='') => `${repoApi}/contents/${path}`;
  const branchesApi  = `${repoApi}`;
  const treeApi      = (sha) => `${repoApi}/git/trees/${sha}?recursive=1`;

  const statusEl = document.getElementById('status');
  const grid = document.getElementById('grid');
  const search = document.getElementById('search');
  const folderFilter = document.getElementById('folderFilter');

  // GitHub Pages base URL for relative links (works both on Pages and local preview)
  const pagesBase = `${location.origin}/${OWNER}.github.io` === location.origin
    ? `${location.origin}/${REPO}/`
    : `${location.origin}${location.pathname.replace(/[^/]*$/, '')}`;

  // Helper: escape HTML
  const esc = (s) => s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

  try {
    // 1) Discover default branch
    const repoInfo = await fetch(branchesApi).then(r => r.json());
    const defaultBranch = repoInfo.default_branch || 'main';

    // 2) Get the full tree (recursive) for the default branch
    const branch = await fetch(`${repoApi}/branches/${defaultBranch}`).then(r => r.json());
    const tree = await fetch(treeApi(branch.commit.sha)).then(r => r.json());

    if (!tree || !Array.isArray(tree.tree)) throw new Error('Could not fetch tree');

    // 3) Build file lists/sets
    const allEntries = tree.tree.filter(e => e.type === 'blob');
    const htmlFiles = allEntries
      .filter(f => f.path.toLowerCase().endsWith('.html'))
      .filter(f => !/^(?:index|readme)\.html$/i.test(f.path.split('/').pop())); // ignore index.html/readme.html
    const images = allEntries.filter(f => /\.(png|jpe?g|webp)$/i.test(f.path));
    const imageSet = new Set(images.map(f => f.path.toLowerCase()));

    // 4) Build folder options
    const folders = Array.from(new Set(htmlFiles.map(f => f.path.includes('/') ? f.path.split('/').slice(0,-1).join('/') : '(root)'))).sort();
    folders.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p === '(root)' ? '' : p;
      opt.textContent = p;
      folderFilter.appendChild(opt);
    });

    // 5) Render cards
    const cards = htmlFiles.map(file => {
      const path = file.path;                           // e.g., "maps/shan-state-timelines-map.html"
      const fileName = path.split('/').pop();          // e.g., "shan-state-timelines-map.html"
      const base = fileName.replace(/\.[^.]+$/,'');    // "shan-state-timelines-map"
      const folder = path.includes('/') ? path.split('/').slice(0,-1).join('/') : '';

      const candidateThumbs = [`${folder?folder+'/':''}${base}.png`, `${folder?folder+'/':''}${base}.jpg`, `${folder?folder+'/':''}${base}.jpeg`, `${folder?folder+'/':''}${base}.webp`];
      const thumbPath = candidateThumbs.find(p => imageSet.has(p.toLowerCase()));
      const pagesLink = `./${encodeURI(path)}`;  // relative link works on Pages
      const rawLink   = `https://raw.githubusercontent.com/${OWNER}/${REPO}/${defaultBranch}/${encodeURI(path)}`;
      const ghLink    = `https://github.com/${OWNER}/${REPO}/blob/${defaultBranch}/${encodeURI(path)}`;

      // card element
      const card = document.createElement('article');
      card.className = 'card';
      card.dataset.path = path;
      card.dataset.folder = folder;
      card.dataset.name = base.toLowerCase();

      const thumb = document.createElement('div');
      thumb.className = 'thumb';
      if (thumbPath) {
        const img = document.createElement('img');
        img.alt = base;
        img.loading = 'lazy';
        img.src = `./${encodeURI(thumbPath)}`;
        thumb.appendChild(img);
      } else {
        const fb = document.createElement('div');
        fb.className = 'fallback';
        fb.textContent = 'No thumbnail';
        thumb.appendChild(fb);
      }

      const meta = document.createElement('div');
      meta.className = 'meta';

      const name = document.createElement('div');
      name.className = 'name';
      name.innerHTML = `<a href="${pagesLink}">${esc(fileName)}</a>`;

      const row = document.createElement('div');
      row.className = 'row';
      const where = document.createElement('div');
      where.className = 'badges';
      if (folder) {
        const b = document.createElement('span'); b.className='badge'; b.textContent=folder;
        where.appendChild(b);
      } else {
        const b = document.createElement('span'); b.className='badge'; b.textContent='(root)';
        where.appendChild(b);
      }
      const size = document.createElement('div');
      size.textContent = `${(file.size/1024).toFixed(1)} KB`;

      row.appendChild(where);
      row.appendChild(size);

      const links = document.createElement('div');
      links.className = 'links';
      links.innerHTML = `
        <a class="btn" href="${pagesLink}">Open</a>
        <a class="btn" href="${ghLink}" target="_blank" rel="noopener">View on GitHub</a>
        <a class="btn" href="${rawLink}" target="_blank" rel="noopener">Raw</a>
      `;

      meta.appendChild(name);
      meta.appendChild(row);
      meta.appendChild(links);

      card.appendChild(thumb);
      card.appendChild(meta);
      return card;
    });

    grid.replaceChildren(...cards);
    statusEl.textContent = `Found ${cards.length} map file${cards.length!==1?'s':''} in ‚Äú${OWNER}/${REPO}‚Äù (branch: ${defaultBranch}).`;

    // 6) Filters
    function applyFilters(){
      const q = (search.value || '').trim().toLowerCase();
      const folderVal = folderFilter.value;
      for (const card of grid.children) {
        const matchesText = !q || card.dataset.name.includes(q) || card.dataset.path.toLowerCase().includes(q);
        const matchesFolder = !folderVal || card.dataset.folder === folderVal;
        card.classList.toggle('hidden', !(matchesText && matchesFolder));
      }
    }
    search.addEventListener('input', applyFilters);
    folderFilter.addEventListener('change', applyFilters);

  } catch (e) {
    console.error(e);
    statusEl.textContent = 'Failed to load file list from GitHub API. (Unauthenticated rate limit is ~60 requests/hour.)';
  }
})();
</script>
</body>
</html>
